name: C/C++ CI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  x86_ubuntu_build:
    name: Build on x86
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo bash docker/scripts/install_dependencies.sh

      - name: Build srsRAN (Docker builder)
        run: |
          bash docker/scripts/builder.sh -c gcc -m "-j$(nproc)" -DBUILD_TESTING=On .

      # Keep tests ONLY if build/ exists on the runner
      - name: Run unit tests (only if build exists on runner)
        if: ${{ hashFiles('build/CTestTestfile.cmake') != '' }}
        run: |
          cd build
          ctest -j"$(nproc)" --schedule-random --output-on-failure
